{{ define "main" }}
<main class="album-wrap">

    {{/* 1. Identify Album & Fetch Cloud Data */}}
    {{ $albumDir := .Params.album | default (path.Base .File.Dir) }}

    {{/* Construct CloudFront URL */}}
    {{ $configUrl := printf "https://d1f1sorz2edz9k.cloudfront.net/images/configs/%s.json" ($albumDir | lower) }}

    {{ $meta := dict }}
    {{ $res := resources.GetRemote $configUrl }}

    {{ if $res }}
    {{ $meta = transform.Unmarshal $res }}
    {{ else }}
    {{/* Fallback error message if JSON is missing in S3 */}}
    <div class="av-note">
        Could not fetch config: <code>{{ $configUrl }}</code>
    </div>
    {{ end }}

    <header class="album-header">
        <h1>{{ or $meta.title .Title }}</h1>
        {{ with $meta.description }}<p class="album-meta">{{ . }}</p>{{ end }}
    </header>

    {{ if $meta.images }}
    <section class="album-grid" aria-live="polite">
        {{ range $meta.images }}

        {{/* Aspect Ratio Logic */}}
        {{ $w := float (default 1500 .width) }}
        {{ $h := float (default 1000 .height) }}
        {{ $aspect := div $w $h }}

        <figure class="album-tile" style="flex-grow: {{ $aspect }}; flex-basis: {{ mul $aspect 250 }}px;">
            <a class="album-link"
               href="{{ .src }}"
               target="_blank"
               data-pswp-src="{{ .src }}"
               data-pswp-width="{{ .width }}"
               data-pswp-height="{{ .height }}"
               data-pswp-caption="{{ .name }}">

                {{/* Display the THUMBNAIL from S3 (small size)
                But link to the SRC (full size)
                */}}
                <img class="grid-img"
                     src="{{ .thumb }}"
                     alt="{{ .name }}"
                     loading="lazy"
                     decoding="async"
                     style="aspect-ratio: {{ $w }} / {{ $h }};">
            </a>
        </figure>
        {{ end }}

        <div style="flex-grow: 100; content: '';"></div>
    </section>
    {{ end }}

</main>
{{ end }}
{{ define "main" }}
<main class="gallery-wrap" aria-label="Gallery">
    {{ $imgs := resources.Match "images/featured/*.{jpg,jpeg,png,webp}" | sort }}
    {{ if gt (len $imgs) 0 }}
    <div class="scroller-outer">
        <div id="peeler" class="peeler" tabindex="0" aria-label="Image carousel"
             data-autoplay="true" data-interval="4000" data-pause-on-hover="true"
             data-pause-on-interaction="true" data-resume-after="3000">
            {{ range $i, $img := $imgs }}
            <figure class="peel-slide" role="group" aria-roledescription="slide"
                    aria-label="Slide {{ add $i 1 }} of {{ len $imgs }}">
                <div class="peel-inner">
                    {{ $hi := ($img.Resize "2000x") }}
                    {{ $lq := ($img.Resize "40x") }}
                    <img class="peel-img lazy"
                         src="{{ $lq.RelPermalink }}"
                         data-src="{{ $hi.RelPermalink }}"
                         alt="{{ $img.Name }}"
                         loading="lazy" />
                </div>
            </figure>
            {{ end }}
        </div>
    </div>
    {{ else }}
    <p class="no-images">No images found in assets/images/featured.</p>
    {{ end }}

    {{/* Thumbnail grid below the carousel */}}
    <section class="thumbnail-grid-wrap" aria-label="Gallery thumbnails">
        {{ $entries := readDir "assets/images/gallery" }}
        {{ $folders := slice }}
        {{ range $entries }}
        {{ if .IsDir }}
        {{ $folders = $folders | append .Name }}
        {{ end }}
        {{ end }}

        {{/* Preload corner image resource once (use PNG path you mentioned) */}}
        {{ $cornerScratch := newScratch }}
        {{ with resources.Get "images/image_corner.png" }}
        {{ with .Resize "48x48" }}
        {{ $cornerScratch.Set "img" . }}
        {{ end }}
        {{ end }}


        {{ if gt (len $folders) 0 }}
        <div class="thumbnail-grid">
            {{ range $idx, $folder := $folders }}
            {{ $pattern := printf "images/gallery/%s/*.{jpg,jpeg,png,webp}" $folder }}
            {{ $imgs := resources.Match $pattern | sort }}
            {{ if gt (len $imgs) 0 }}
            {{ $defaultChosen := index $imgs 0 }}

            {{ $meta := dict "title" (printf "%s" $folder) "badge" "Gallery" "caption" "" "thumbnail" "" }}
            {{ $metaPath := printf "assets/images/gallery/%s/meta.json" $folder }}
            {{ if fileExists $metaPath }}
            {{ $raw := readFile $metaPath }}
            {{ $parsed := transform.Unmarshal $raw }}
            {{ if $parsed }}
            {{ $meta = merge $meta $parsed }}
            {{ end }}
            {{ end }}

            {{ $fs := newScratch }}
            {{ $thumbFilename := printf "%s" (index $meta "thumbnail") }}
            {{ if ne $thumbFilename "" }}
            {{ $maybePath := printf "images/gallery/%s/%s" $folder $thumbFilename }}
            {{ with resources.Get $maybePath }}
            {{ $fs.Set "thumb" . }}
            {{ end }}
            {{ end }}
            {{ if not ($fs.Get "thumb") }}
            {{ $fs.Set "thumb" $defaultChosen }}
            {{ end }}
            {{ $thumbRes := $fs.Get "thumb" }}
            {{ $thumbSrc := $thumbRes.Resize "1200x" }}

            <article class="thumb-card"
                     tabindex="0"
                     role="link"
                     data-target="/gallery/{{ $folder | urlize }}/"
                     aria-label="Open gallery {{ $folder }}">
                <div class="thumb-media">
                    <img class="thumb-img"
                         src="{{ $thumbSrc.RelPermalink }}"
                         alt="{{ index $meta "title" }}"
                    loading="lazy"
                    width="1200" height="800">

                    {{/* shutter logo â€” handle SVG vs raster safely */}}
                    {{ with resources.Get "images/shutter_logo.svg" }}
                    {{ if eq .MediaType.SubType "svg" }}
                    <img class="shutter-logo" src="{{ .RelPermalink }}" alt="shutter logo" aria-hidden="true">
                    {{ else }}
                    {{ $logo := .Resize "48x48" }}
                    <img class="shutter-logo" src="{{ $logo.RelPermalink }}" alt="shutter logo" aria-hidden="true">
                    {{ end }}
                    {{ else }}
                    {{ with resources.Get "images/shutter_logo.png" }}
                    {{ $logo := .Resize "48x48" }}
                    <img class="shutter-logo" src="{{ $logo.RelPermalink }}" alt="shutter logo" aria-hidden="true">
                    {{ end }}
                    {{ end }}

                    {{ $cornerImg := $cornerScratch.Get "img" }}
                    {{ if $cornerImg }}
                    <img class="corner-img tl" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                    <img class="corner-img tr" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                    <img class="corner-img br" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                    <img class="corner-img bl" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                    {{ end }}

                </div>

                <div class="thumb-body">
                    <div class="thumb-text">
                        <h4 class="thumb-title">{{ index $meta "title" }}</h4>
                        <p class="thumb-caption">{{ index $meta "caption" }}</p>
                    </div>
                    <span class="thumb-badge">{{ index $meta "badge" }}</span>
                </div>
            </article>
            {{ end }}
            {{ end }}
        </div>
        {{ else }}
        <p class="no-thumbs">No gallery folders found in <code>assets/images/gallery</code>.</p>
        {{ end }}
    </section>
</main>

{{ block "scripts" . }}
<script src="{{ "js/peel-scroller.js" | relURL }}" defer></script>

<script>
    (function () {
        // click / keyboard handlers
        document.addEventListener('click', function (e) {
            var card = e.target.closest && e.target.closest('.thumb-card');
            if (!card) return;
            var target = card.getAttribute('data-target');
            if (target) window.location.href = target;
        }, true);

        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
                var el = document.activeElement;
                if (el && el.classList.contains('thumb-card')) {
                    var target = el.getAttribute('data-target');
                    if (target) {
                        e.preventDefault();
                        window.location.href = target;
                    }
                }
            }
        });

        // touch devices: quick tap toggles hover-like state so caption/logo animation can show
        document.querySelectorAll('.thumb-card').forEach(function(card){
            card.addEventListener('touchstart', function(){
                card.classList.add('touch-hover');
                setTimeout(function(){ card.classList.remove('touch-hover'); }, 2500);
            }, {passive:true});
        });

    })();
</script>
{{ end }}
{{ end }}

{{ define "main" }}
<main class="gallery-wrap" aria-label="Gallery">

    {{/* ==========================
    1. CAROUSEL SECTION (Fixed: Filters non-images + RESTORED LIGHTBOX DATA)
    ========================== */}}

    {{ $cornerScratch := newScratch }}
    {{ with resources.Get "logos/image_corner.png" }}
    {{ with .Resize "48x48" }}{{ $cornerScratch.Set "img" . }}{{ end }}
    {{ end }}

    {{/* STRICT IMAGE FILTERING */}}
    {{- $rawFiles := resources.Match "images/carousal/*" -}}
    {{- $validImages := slice -}}
    {{- $allowedExts := slice ".jpg" ".jpeg" ".png" ".webp" ".avif" -}}

    {{- range $rawFiles -}}
    {{- $ext := path.Ext .Name | lower -}}
    {{- if in $allowedExts $ext -}}
    {{- $validImages = $validImages | append . -}}
    {{- end -}}
    {{- end -}}

    {{- if gt (len $validImages) 0 }}
    <section class="featured-carousel">
        <nav class="hover-carousel">
            {{- range $i, $res := $validImages }}
            {{/* CRITICAL FIX:
            We added back 'data-pswp-src', 'width', and 'height'.
            The lightbox script looks for these to know what to open.
            */}}
            <div class="hc-container"
                 tabindex="0"
                 data-index="{{ $i }}"
                 role="button"
                 data-hi2x="{{ $res.RelPermalink }}"
                 data-pswp-src="{{ $res.RelPermalink }}"
                 data-pswp-width="{{ $res.Width }}"
                 data-pswp-height="{{ $res.Height }}">

                {{/* Safe to resize now */}}
                <img class="hc-img"
                     src="{{ ($res.Resize "600x").RelPermalink }}"
                alt="{{ $res.Name }}" />
            </div>
            {{- end }}
        </nav>
    </section>
    {{- end }}

    {{/* ==========================
    2. INTRO
    ========================== */}}
    <section class="gallery-intro">
        <h2 class="intro-title">A glimpse through <span class="intro-em">my perspective</span></h2>
        <p class="intro-sub">
            I love capturing photos. Some of my favorites are here.
        </p>
    </section>

    {{/* ==========================
    ALBUM GRID (Fully Remote)
    ========================== */}}
    <section class="thumbnail-grid-wrap">

        {{/* 1. Fetch the Master Manifest from S3 */}}
        {{ $manifestUrl := "https://d1f1sorz2edz9k.cloudfront.net/images/configs/manifest.json" }}

        {{/* Use headers to try and bypass cache for the list */}}
        {{ $manifestRes := resources.GetRemote $manifestUrl }}

        <div class="thumbnail-grid">
            {{ if $manifestRes }}
            {{/* 2. Loop through the list of albums ["air_camera", "europe", ...] */}}
            {{ $albums := transform.Unmarshal $manifestRes }}

            {{ range $albums }}
            {{ $folder := . }}
            {{ $configUrl := printf "https://d1f1sorz2edz9k.cloudfront.net/images/configs/%s.json" $folder }}

            {{/* 3. Fetch individual album config */}}
            {{ $res := resources.GetRemote $configUrl }}

            {{ if $res }}
            {{ if eq $res.MediaType.SubType "json" }}
            {{ $meta := transform.Unmarshal $res }}
            {{ $thumbUrl := "" }}

            {{/* Thumbnail Logic */}}
            {{ if $meta.thumbnail }}
            {{ if in $meta.thumbnail "http" }}
            {{ $thumbUrl = $meta.thumbnail }}
            {{ else }}
            {{ $thumbUrl = printf "https://d1f1sorz2edz9k.cloudfront.net/images/thumbs/%s/thumb_%s" $folder $meta.thumbnail }}
            {{ end }}
            {{ else if gt (len $meta.images) 0 }}
            {{ $first := index $meta.images 0 }}
            {{ $thumbUrl = $first.thumb }}
            {{ end }}

            {{ if ne $thumbUrl "" }}
            <article class="thumb-card" tabindex="0" data-album="{{ $folder }}">
                {{/* Note: This link assumes you have a markdown file or section for this album */}}
                <a class="thumb-link" href="/album-viewer/{{ $folder | urlize }}/">
                    <div class="thumb-media">
                        <img class="thumb-img" src="{{ $thumbUrl }}" loading="lazy"
                             style="object-fit: cover; aspect-ratio: 3/2;">

                        {{/* Decorations */}}
                        {{ with resources.Get "logos/shutter_logo.svg" }}<img class="shutter-logo" src="{{ .RelPermalink }}">{{ end }}
                        {{ with resources.Get "logos/image_corner.png" }}
                        {{ with .Resize "48x48" }}
                        <img class="corner-img tl" src="{{ .RelPermalink }}" />
                        <img class="corner-img tr" src="{{ .RelPermalink }}" />
                        <img class="corner-img br" src="{{ .RelPermalink }}" />
                        <img class="corner-img bl" src="{{ .RelPermalink }}" />
                        {{ end }}
                        {{ end }}
                    </div>
                </a>
                <div class="thumb-body">
                    <div class="thumb-text">
                        <h4 class="thumb-title">{{ $meta.title }}</h4>
                        <p class="thumb-caption">{{ default "" $meta.description }}</p>
                    </div>
                    <span class="thumb-badge">Gallery</span>
                </div>
            </article>
            {{ end }}
            {{ end }}
            {{ end }}
            {{ end }}
            {{ else }}
            <p>Unable to load album list from cloud.</p>
            {{ end }}
        </div>
    </section>

</main>
{{ end }}
{{ define "main" }}
<main class="gallery-wrap" aria-label="Gallery">
    {{ $imgs := resources.Match "images/featured/*.{jpg,jpeg,png,webp}" | sort }}
    {{ if gt (len $imgs) 0 }}
    <div class="scroller-outer">
        <div id="peeler" class="peeler" aria-label="Image carousel"
             data-autoplay="true" data-interval="4000" data-pause-on-hover="true"
             data-pause-on-interaction="true" data-resume-after="3000">
            {{ range $i, $img := $imgs }}
            <figure class="peel-slide" role="group" aria-roledescription="slide"
                    aria-label="Slide {{ add $i 1 }} of {{ len $imgs }}">
                <div class="peel-inner">
                    {{ $small := $img.Resize "600x" }}
                    {{ $med   := $img.Resize "1200x" }}
                    {{ $hi    := $img.Resize "2000x" }}
                    {{ $lq    := $img.Resize "40x" }}
                    <img class="peel-img lazy"
                         src="{{ $small.RelPermalink }}"
                         srcset="{{ $small.RelPermalink }} 600w, {{ $med.RelPermalink }} 1200w, {{ $hi.RelPermalink }} 2000w"
                         sizes="(max-width: 640px) 100vw, 60vw"
                         alt="{{ $img.Name }}" loading="lazy" decoding="async" width="1200" height="800">
                </div>
            </figure>
            {{ end }}
        </div>
    </div>
    {{ else }}
    <p class="no-images">No images found in assets/images/featured.</p>
    {{ end }}

    <!-- Gallery intro: insert between carousel and thumbnails -->
    <section class="gallery-intro" aria-hidden="false">
        <div class="intro-pill">My Portfolios</div>

        <h2 class="intro-title">
            A glimpse through <span class="intro-em">my perspective</span>
        </h2>

        <p class="intro-sub">
            I take way too many photos. Some of my favorites are here.
        </p>
    </section>


    {{/* Thumbnail grid below the carousel */}}
    <section class="thumbnail-grid-wrap" aria-label="Gallery thumbnails">
        {{ $entries := readDir "assets/images/gallery" }}
        {{ $folders := slice }}
        {{ range $entries }}
        {{ if .IsDir }}
        {{ $folders = $folders | append .Name }}
        {{ end }}
        {{ end }}

        {{/* Preload corner image resource once */}}
        {{ $cornerScratch := newScratch }}
        {{ with resources.Get "images/image_corner.png" }}
        {{ with .Resize "48x48" }}
        {{ $cornerScratch.Set "img" . }}
        {{ end }}
        {{ end }}

        {{ if gt (len $folders) 0 }}
        <div class="thumbnail-grid">
            {{ range $idx, $folder := $folders }}
            {{ $pattern := printf "images/gallery/%s/*" $folder }}
            {{ $resources := resources.Match $pattern | sort }}
            {{/* Build $imgs by extension to avoid meta.json and others */}}
            {{ $imgs := slice }}
            {{ range $resources }}
            {{ $ext := lower (replaceRE "^.*\\.([^.]+)$" "$1" .Name) }}
            {{ if in (slice "jpg" "jpeg" "png" "webp" "gif") $ext }}
            {{ $imgs = $imgs | append . }}
            {{ end }}
            {{ end }}
            {{ if gt (len $imgs) 0 }}
            {{ $defaultChosen := index $imgs 0 }}

            {{ $meta := dict "title" (printf "%s" $folder) "badge" "Gallery" "caption" "" "thumbnail" "" }}
            {{ $metaPath := printf "assets/images/gallery/%s/meta.json" $folder }}
            {{ if fileExists $metaPath }}
            {{ $raw := readFile $metaPath }}
            {{ $parsed := transform.Unmarshal $raw }}
            {{ if $parsed }}
            {{ $meta = merge $meta $parsed }}
            {{ end }}
            {{ end }}

            {{ $fs := newScratch }}
            {{ $thumbFilename := printf "%s" (index $meta "thumbnail") }}
            {{ if ne $thumbFilename "" }}
            {{ $maybePath := printf "images/gallery/%s/%s" $folder $thumbFilename }}
            {{ with resources.Get $maybePath }}
            {{ $fs.Set "thumb" . }}
            {{ end }}
            {{ end }}
            {{ if not ($fs.Get "thumb") }}
            {{ $fs.Set "thumb" $defaultChosen }}
            {{ end }}
            {{ $thumbRes := $fs.Get "thumb" }}

            {{/* Generate sizes: small for grid, med for larger screens, hi for album viewer/lightbox */}}
            {{ $small := $thumbRes.Fill "600x" }}
            {{ $med := $thumbRes.Resize "1200x" }}
            {{ $hi := $thumbRes.Resize "2000x" }}

            <article class="thumb-card" tabindex="0" role="link" aria-label="Open album {{ $folder }}" data-album="{{ $folder }}">
                <a class="thumb-link" href="/album-viewer/{{ $folder | urlize }}/" aria-hidden="true">
                    <div class="thumb-media">
                        <img class="thumb-img"
                             src="{{ $small.RelPermalink }}"
                             srcset="{{ $small.RelPermalink }} 600w, {{ $med.RelPermalink }} 1200w"
                             sizes="(max-width:640px) 100vw, (max-width:1200px) 50vw, 33vw"
                             alt="{{ index $meta "title" }}"
                        loading="lazy"
                        width="1200" height="800">

                        {{/* shutter logo */}}
                        {{ with resources.Get "images/shutter_logo.svg" }}
                        <img class="shutter-logo" src="{{ .RelPermalink }}" alt="shutter logo" aria-hidden="true">
                        {{ else }}
                        {{ with resources.Get "images/shutter_logo.png" }}
                        {{ $logo := .Resize "48x48" }}
                        <img class="shutter-logo" src="{{ $logo.RelPermalink }}" alt="shutter logo" aria-hidden="true">
                        {{ end }}
                        {{ end }}

                        {{ $cornerImg := $cornerScratch.Get "img" }}
                        {{ if $cornerImg }}
                        <img class="corner-img tl" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                        <img class="corner-img tr" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                        <img class="corner-img br" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                        <img class="corner-img bl" src="{{ $cornerImg.RelPermalink }}" alt="" aria-hidden="true" />
                        {{ end }}
                    </div>
                </a>

                <div class="thumb-body">
                    <div class="thumb-text">
                        <h4 class="thumb-title">{{ index $meta "title" }}</h4>
                        <p class="thumb-caption">{{ index $meta "caption" }}</p>
                    </div>
                    <span class="thumb-badge">{{ index $meta "badge" }}</span>
                </div>
            </article>
            {{ end }}
            {{ end }}
        </div>
        {{ else }}
        <p class="no-thumbs">No gallery folders found in <code>assets/images/gallery</code>.</p>
        {{ end }}
    </section>
</main>

{{ block "scripts" . }}
<script>
    (function () {
        'use strict';

        // Navigate to album-viewer page on click
        document.addEventListener('click', function (e) {
            const card = e.target.closest && e.target.closest('.thumb-card');
            if (!card) return;
            const album = card.getAttribute('data-album');
            if (album) window.location.href = `/album-viewer/${album}/`;
        }, true);

        // Keyboard navigation (Enter / Space)
        document.addEventListener('keydown', function (e) {
            if (e.key === 'Enter' || e.key === ' ') {
                const el = document.activeElement;
                if (el && el.classList.contains('thumb-card')) {
                    const album = el.getAttribute('data-album');
                    if (album) {
                        e.preventDefault();
                        window.location.href = `/album-viewer/${album}/`;
                    }
                }
            }
        });

        // Touch devices: quick tap toggles hover-like state
        document.querySelectorAll('.thumb-card').forEach(function(card){
            card.addEventListener('touchstart', function(){
                card.classList.add('touch-hover');
                setTimeout(function(){ card.classList.remove('touch-hover'); }, 2500);
            }, {passive:true});
        });

    })();
</script>

{{ end }}
{{ end }}
